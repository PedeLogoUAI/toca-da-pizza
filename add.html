<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Produtos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            background-color: #f8f9fa;
            text-align: center;
            border-bottom: 1px solid #ddd;
            display: none;
        }
        #response {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            display: none;
            text-align: center;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Carregando dados...</div>
    
    <h1>Cadastro de Produtos</h1>
    <form id="produtoForm">
        <div class="form-group">
            <label for="categoria">Categoria:</label>
            <select id="categoria" name="categoria" required>
                <option value="">Selecione uma categoria</option>
                <!-- As opções serão preenchidas via JavaScript -->
            </select>
        </div>
        
        <div class="form-group">
            <label for="produto">Produto:</label>
            <input type="text" id="produto" name="produto" required>
        </div>
        
        <div class="form-group">
            <label for="descricao">Descrição:</label>
            <textarea id="descricao" name="descricao" rows="3"></textarea>
        </div>
        
        <div class="form-group">
            <label for="valor">Valor (R$):</label>
            <input type="number" id="valor" name="valor" step="0.01" required>
        </div>
        
        <div class="form-group">
            <label for="imagem">URL da Imagem:</label>
            <input type="text" id="imagem" name="imagem">
        </div>
        
        <button type="submit" id="submitBtn">Cadastrar Produto</button>
    </form>
    
    <div id="response"></div>

    <script>
        // Variáveis globais
        let proximoId = 0;
        let categoriasDisponiveis = [];
        let podeEnviar = true;
        
        // Mapeamento de categorias para URLs de imagem
        const categoriaParaImagem = {
            'Pizzas': 'imagens/pizzas.jpeg',
            'Panuozzos': 'imagens/panuozzos.jpg',
            'Hamburguers': 'imagens/hamburguers.jpg',
            'Hot Dogs': 'imagens/hotdogs.jpg',
            'Bebidas': 'imagens/bebidas.jpg',
            'Promoções e Combos': 'imagens/promocoes.jpg'
        };
        
        // Função para buscar categorias e próximo ID
        async function buscarDadosIniciais() {
            const loadingDiv = document.getElementById('loading');
            const categoriaSelect = document.getElementById('categoria');
            
            loadingDiv.style.display = 'block';
            
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwU0J8BjZPTRSxOdQUQMY00e2LzzFv7Rr88uY0BagqMIbdStjwEHC_lhKHg1uZjiV4h/exec');
                const data = await response.json();
                
                proximoId = data.produtos.length + 1;
                categoriasDisponiveis = [...new Set(data.produtos.map(p => p.categoria))];
                
                // Adiciona categorias padrão se não existirem
                Object.keys(categoriaParaImagem).forEach(cat => {
                    if (!categoriasDisponiveis.includes(cat)) {
                        categoriasDisponiveis.push(cat);
                    }
                });
                
                categoriaSelect.innerHTML = '<option value="">Selecione uma categoria</option>';
                categoriasDisponiveis.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = categoria;
                    categoriaSelect.appendChild(option);
                });
                
                loadingDiv.style.display = 'none';
                
            } catch (error) {
                console.error("Erro ao buscar dados:", error);
                loadingDiv.style.display = 'none';
                const responseDiv = document.getElementById('response');
                responseDiv.textContent = "Erro ao carregar categorias. Tente recarregar a página.";
                responseDiv.className = "error";
                responseDiv.style.display = 'block';
            }
        }
        
        // Preenche a URL da imagem baseada na categoria selecionada
        document.getElementById('categoria').addEventListener('change', function() {
            const categoriaSelecionada = this.value;
            const imagemInput = document.getElementById('imagem');
            
            if (categoriaParaImagem[categoriaSelecionada]) {
                imagemInput.value = categoriaParaImagem[categoriaSelecionada];
            } else {
                imagemInput.value = '';
            }
        });
        
        // Busca os dados quando a página carrega
        document.addEventListener('DOMContentLoaded', buscarDadosIniciais);

        // Envio do formulário
        document.getElementById('produtoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!podeEnviar) return;
            
            const form = e.target;
            const responseDiv = document.getElementById('response');
            const loadingDiv = document.getElementById('loading');
            const submitBtn = document.getElementById('submitBtn');
            
            responseDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            submitBtn.disabled = true;
            podeEnviar = false;
            
            // Monta os dados do produto
            const dadosProduto = {
                id: proximoId,
                categoria: form.categoria.value,
                produto: form.produto.value,
                descricao: form.descricao.value,
                valor: form.valor.value,
                quantidade: 0,
                imagem: form.imagem.value
            };
            
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwU0J8BjZPTRSxOdQUQMY00e2LzzFv7Rr88uY0BagqMIbdStjwEHC_lhKHg1uZjiV4h/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(dadosProduto).toString()
                });
                
                const result = await response.json();
                loadingDiv.style.display = 'none';
                
                if (result.status === 'success') {
                    responseDiv.textContent = 'Produto cadastrado.';
                    responseDiv.className = 'success';
                    form.reset();
                    
                    await buscarDadosIniciais();
                    
                    setTimeout(() => {
                        responseDiv.style.display = 'none';
                    }, 5000);
                    
                } else {
                    responseDiv.textContent = `Erro: ${result.message || 'Erro desconhecido'}`;
                    responseDiv.className = 'error';
                }
                
                responseDiv.style.display = 'block';
            } catch (error) {
                loadingDiv.style.display = 'none';
                responseDiv.textContent = `Erro na conexão: ${error.message}`;
                responseDiv.className = 'error';
                responseDiv.style.display = 'block';
            } finally {
                // Habilita o botão após 2 segundos
                setTimeout(() => {
                    submitBtn.disabled = false;
                    podeEnviar = true;
                }, 500);
            }
        });
    </script>
</body>
</html>
